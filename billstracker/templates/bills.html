{% extends 'main.html' %}

{% block content %}

  <!-- <div class="row mb-3">
    <div class="col">
      <h2>Bills List</h2>
  </div> -->

  <div class="row mb-2 text-end">
    <div>
      <button id="tableViewBtn" class="btn btn-outline-primary"><i class="bi bi-table"></i></button>
      <button id="calendarViewBtn" class="btn btn-outline-secondary"><i class="bi bi-calendar"></i></button>
    </div>
  </div>

  <div class="row mb-1">
    <div class="col-sm-12 col-md-2 mb-2">
      <a href="{% url 'create-bill' %}" class="btn btn-success"><i class="bi bi-plus-lg"></i>Add Bill {{ selected_month }}</a>
    </div>

    <div class="col-sm-12 col-md-2 mb-2">
      <select id="monthFilter" class="form-select me-2">
        <option value="all">All Months</option>
        <option value="1" {% if date_month_now == 1 %} selected {% endif %}>January</option>
        <option value="2" {% if date_month_now == 2 %} selected {% endif %}>February</option>
        <option value="3" {% if date_month_now == 3 %} selected {% endif %}>March</option>
        <option value="4" {% if date_month_now == 4 %} selected {% endif %}>April</option>
        <option value="5" {% if date_month_now == 5 %} selected {% endif %}>May</option>
        <option value="6" {% if date_month_now == 6 %} selected {% endif %}>June</option>
        <option value="7" {% if date_month_now == 7 %} selected {% endif %}>July</option>
        <option value="8" {% if date_month_now == 8 %} selected {% endif %}>August</option>
        <option value="9" {% if date_month_now == 9 %} selected {% endif %}>September</option>
        <option value="10" {% if date_month_now == 10 %} selected {% endif %}>October</option>
        <option value="11" {% if date_month_now == 11 %} selected {% endif %}>November</option>
        <option value="12" {% if date_month_now == 12 %} selected {% endif %}>December</option>
      </select>
    </div>

    <div class="col-sm-12 col-md-2 mb-2">
      <select id="yearFilter" class="form-select me-2">
        <option value="all">All Years</option>
        <option value="2024" {% if date_year_now == 2024 %} selected {% endif %}>2024</option>
        <option value="2025" {% if date_year_now == 2025 %} selected {% endif %}>2025</option>
        <option value="2026" {% if date_year_now == 2026 %} selected {% endif %}>2026</option>
        <option value="2027" {% if date_year_now == 2027 %} selected {% endif %}>2027</option>
        <option value="2028" {% if date_year_now == 2028 %} selected {% endif %}>2028</option>
        <option value="2029" {% if date_year_now == 2029 %} selected {% endif %}>2029</option>
        <option value="2030" {% if date_year_now == 2030 %} selected {% endif %}>2030</option>
      </select>
    </div>

    <!-- <div class="col-sm-12 col-md-6 mb-2">
      <form method="get">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search..." name="search_area" value="{{ search_input }}">
          <button class="btn btn-success" type="submit" id="button-addon2">Search</button>
        </div>
        <input type="hidden" name="selected_month" id="id_selected_month">
      </form>
    </div> -->

    <div class="col-sm-12 col-md-6 mb-2">
      <input type="text" id="id_searchInput" class="form-control" placeholder="Search bills...">
    </div>
  </div>

  <div class="row table-responsive mb-3" id="tableView">
    <table class="table table-hover table-striped text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col">Bill Name</th>
          <th scope="col">Category</th>
          <th scope="col">Due Date</th>
          <th scope="col">Balance</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody class="table-group-divider" id="billTableBody">

        {% for bill in bills %}
        <tr data-month="{{ bill.due_date.month }}" data-year="{{ bill.due_date.year }}">
          <td>{{ bill.bill_detail.name }}</td>
          <td>{{ bill.bill_detail.category.name }}</td>
          <td>{{ bill.due_date }}</td>
          <td>&#8369; {{ bill.amount_payable }}</td>
          <td>
            <a href="{% url 'bill-view' bill.id %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-info-circle"></i></a>
            <a href="{% url 'bill-update' bill.id %}" class="btn btn-outline-success btn-sm"><i class="bi bi-pencil-square"></i></a>
            <a href="{% url 'pay-bill' bill.id bill.bill_detail.id %}" class="btn btn-outline-warning btn-sm {% if bill.amount_payable <= 0 %} disabled {% endif %}"><i class="bi bi-wallet2"></i></a>

          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const tableView = document.getElementById("tableView");
      const monthFilter = document.getElementById("monthFilter");
      const yearFilter = document.getElementById("yearFilter");
      const searchInput = document.getElementById("id_searchInput");
      
      // Month and Year Filter
      monthFilter.addEventListener("change", function() {
        let selectedMonth = this.value;
        let selectedYear = yearFilter.value;  
        filterBills(selectedMonth, selectedYear, searchInput.value);  
      });
  
      yearFilter.addEventListener("change", function() {
        let selectedMonth = monthFilter.value; 
        let selectedYear = this.value;
        filterBills(selectedMonth, selectedYear, searchInput.value);  
      });
  
      // Function to filter bills by selected month, year, and search term
      function filterBills(selectedMonth, selectedYear, searchValue) {
        document.querySelectorAll("#billTableBody tr").forEach(row => {
          let billMonth = row.getAttribute("data-month");
          let billYear = row.getAttribute("data-year");
          let rowText = ""; 
      
          row.querySelectorAll("td").forEach(td => {
            rowText += td.innerText.toLowerCase();
          });
      
          // Filter by month, year, and search term
          const matchesMonth = (selectedMonth === "all" || selectedMonth === billMonth);
          const matchesYear = (selectedYear === "all" || selectedYear === billYear);
          const matchesSearch = rowText.includes(searchValue.toLowerCase());
          
          row.style.display = (matchesMonth && matchesYear && matchesSearch) ? "" : "none";
        });
      }
      
      // Check selected month, year, and search value on page load
      filterBills(monthFilter.value, yearFilter.value, searchInput.value);
      
      // Search functionality
      searchInput.addEventListener("input", function() {
        let searchValue = this.value;
        filterBills(monthFilter.value, yearFilter.value, searchValue);  // Pass the current selected month, year, and search value
      });
    });
  </script>  
  
{% endblock content %}
  